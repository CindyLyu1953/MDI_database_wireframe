{% extends "base.html" %}

{% block title %}Research Comparison - Questionnaire Database Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/compare.css') }}">
{% endblock %}

{% macro render_feature_cell(paper, summary_value, verbatim_value, feature_key, feature_label, study_index) %}
    {% set summary_text = summary_value or '' %}
    {% set verbatim_text = verbatim_value or '' %}
    {% set has_verbatim = verbatim_text and verbatim_text != 'NOT SPECIFIED' %}
    {% set summary_word_count = summary_text|word_count %}
    {% set needs_truncation = summary_word_count > 30 %}
    {% set display_text = needs_truncation and summary_text|truncate_words(30) or summary_text %}
    {% set condensed_id = feature_key ~ '-condensed-' ~ study_index %}
    {% set verbatim_id = feature_key ~ '-verbatim-' ~ study_index %}
    <div class="feature-content">
        <div class="feature-summary" data-full-text="{{ summary_text|e }}">
            <p>{{ display_text }}</p>
        </div>
        {% if needs_truncation %}
        <div class="feature-full-text hidden" id="{{ condensed_id }}">
            <p>{{ summary_text }}</p>
        </div>
        {% endif %}
        {% if has_verbatim %}
        <div class="feature-full-text hidden" id="{{ verbatim_id }}">
            <p>{{ verbatim_text }}</p>
        </div>
        {% endif %}
        {% if has_verbatim or needs_truncation %}
        <div class="feature-actions">
            {% if needs_truncation %}
            <button class="btn btn-outline btn-sm full-text-trigger"
                data-full-text-id="{{ condensed_id }}"
                data-feature-label="{{ feature_label }}"
                data-study-title="{{ paper.title|e }}"
                data-study-index="{{ study_index }}">
                <span class="btn-text">View Full Text</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
            </button>
            {% endif %}
            {% if has_verbatim %}
            <button class="btn btn-outline btn-sm full-text-trigger"
                data-full-text-id="{{ verbatim_id }}"
                data-feature-label="{{ feature_label }} Verbatim"
                data-study-title="{{ paper.title|e }}"
                data-study-index="{{ study_index }}">
                <span class="btn-text">View Verbatim Text</span>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6,9 12,15 18,9"></polyline>
                </svg>
            </button>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endmacro %}

{% block content %}
<div class="container">
    <!-- Comparison Header -->
    <section class="compare-header">
        <h1 class="page-title">Research Comparison</h1>
        <p class="page-description">Side-by-side comparison of key features from different studies, discovering operationalization differences and measurement method variations</p>
        
        <div class="compare-actions">
            <button class="btn btn-primary" onclick="addStudy()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                Add Study
            </button>
            <button class="btn btn-outline" onclick="downloadComparison()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download Comparison
            </button>
            <button class="btn btn-outline" onclick="saveComparison()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                    <polyline points="7,3 7,8 15,8"></polyline>
                </svg>
                Save Comparison
            </button>
            <button class="btn btn-outline" onclick="clearComparison()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
                Clear Comparison
            </button>
        </div>
    </section>

    <!-- Comparison Content -->
    <section class="compare-content">
        {% if papers %}
        <div class="comparison-table-container">
            <div class="comparison-table">
                <!-- Table Header -->
                <div class="table-header">
                    <div class="header-cell feature-column">Features</div>
                    {% for paper in papers %}
                    <div class="header-cell study-column">
                        <div class="study-header">
                            <h3>Study {{ loop.index }}</h3>
                            <button class="remove-study-btn" type="button" onclick="removeStudy('{{ paper.id }}')" aria-label="Remove study {{ loop.index }}">
                                &times;
                            </button>
                        </div>
                        <div class="study-title">{{ paper.title }}</div>
                        <div class="study-meta">{{ paper.authors|join(', ') }}, {{ paper.year }}</div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Bibliographic Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Bibliographic</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Authors</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {% set authors_text = paper.authors|join(', ') %}
                        {% if authors_text %}
                            {{ render_feature_cell(paper, authors_text, paper.authors_verbatim, 'authors', 'Authors', loop.index) }}
                        {% else %}
                            <div class="feature-content">
                                <div class="feature-summary"><p>—</p></div>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Title</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.title, paper.title_verbatim, 'title', 'Title', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Journal</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.journal, paper.journal_verbatim, 'journal', 'Journal', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Year</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">{{ paper.year }}</div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Citation</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">{{ paper.citation or '' }}</div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Abstract</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.abstract, paper.abstract_verbatim, 'abstract', 'Abstract', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Research Design & Sample Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Research Design & Sample</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Sample Size</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {% set sample_summary = paper.sample_size and "{:,}".format(paper.sample_size) or '' %}
                        {{ render_feature_cell(paper, sample_summary, paper.extracted_features.sample_size_verbatim, 'sample_size', 'Sample Size', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Country / Region</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.country_region, paper.extracted_features.country_region_verbatim, 'country_region', 'Country / Region', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Recruitment Source</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.recruitment_source, paper.extracted_features.recruitment_source_verbatim, 'recruitment_source', 'Recruitment Source', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Demographics</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.demographics, paper.extracted_features.demographics_verbatim, 'demographics', 'Demographics', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Incentive</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.incentive, paper.extracted_features.incentive_verbatim, 'incentive', 'Incentive', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <!-- Measurement & Analysis Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Measurement & Analysis</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Treatment / Independent variable(s)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.independent_variables, paper.extracted_features.independent_variables_verbatim, 'independent_variables', 'Treatment / Independent variable(s)', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Survey Measures (treatment variables)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.survey_questions, paper.extracted_features.survey_questions_verbatim, 'survey_questions_treatment', 'Survey Measures (treatment variables)', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Outcome / Dependent variable(s)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.dependent_variables, paper.extracted_features.dependent_variables_verbatim, 'dependent_variables', 'Outcome / Dependent variable(s)', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Survey Measures (outcome variables)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.survey_questions, paper.extracted_features.survey_questions_verbatim, 'survey_questions_outcome', 'Survey Measures (outcome variables)', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Analysis (estimating equation)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.analysis_equations, paper.extracted_features.analysis_equations_verbatim, 'analysis_equations', 'Analysis (estimating equation)', loop.index) }}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Findings Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Findings</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Main Effects</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.main_effects, paper.extracted_features.main_effects_verbatim, 'main_effects', 'Main Effects', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Moderators</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.moderators, paper.extracted_features.moderators_verbatim, 'moderators', 'Moderators', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Moderation Results</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.moderation_results, paper.extracted_features.moderation_results_verbatim, 'moderation_results', 'Moderation Results', loop.index) }}
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Context Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Socio-cultural context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.sociocultural_context, paper.extracted_features.sociocultural_context_verbatim, 'sociocultural_context', 'Socio-cultural context', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Political context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.political_context, paper.extracted_features.political_context_verbatim, 'political_context', 'Political context', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Platform / Technological context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.platform_technological_context, paper.extracted_features.platform_technological_context_verbatim, 'platform_technological_context', 'Platform / Technological context', loop.index) }}
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Temporal context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell" data-study-index="{{ loop.index }}">
                        {{ render_feature_cell(paper, paper.extracted_features.temporal_context, paper.extracted_features.temporal_context_verbatim, 'temporal_context', 'Temporal context', loop.index) }}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-comparison">
            <h3>No Studies Selected</h3>
            <p>Add studies from search results to compare them side by side.</p>
            <a href="{{ url_for('search') }}" class="btn btn-primary">Add Studies</a>
        </div>
        {% endif %}
    </section>

    <div id="fullTextModal" class="full-text-modal hidden" aria-hidden="true">
        <div class="modal-backdrop" role="presentation"></div>
        <div class="modal-dialog" role="dialog" aria-modal="true">
            <button type="button" class="modal-close" onclick="closeFullTextModal()" aria-label="Close full text">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="modal-header">
                <h3 class="modal-title" id="modalFeatureTitle">Full Text</h3>
                <p class="modal-subtitle" id="modalStudyTitle"></p>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <script id="comparisonData" type="application/json">{{ papers|tojson }}</script>
</div>
{% endblock %}

{% block scripts %}
<script>
    const modalElements = {
        container: null,
        title: null,
        subtitle: null,
        body: null
    };

    let comparisonPapersData = [];
 
    // Load comparison from localStorage if no papers are provided via URL
    document.addEventListener('DOMContentLoaded', function() {
        modalElements.container = document.getElementById('fullTextModal');
        modalElements.title = document.getElementById('modalFeatureTitle');
        modalElements.subtitle = document.getElementById('modalStudyTitle');
        modalElements.body = document.getElementById('modalBody');

        const modalBackdrop = modalElements.container?.querySelector('.modal-backdrop');
        if (modalBackdrop) {
            modalBackdrop.addEventListener('click', closeFullTextModal);
        }

        document.querySelectorAll('.full-text-trigger').forEach(button => {
            button.addEventListener('click', event => {
                event.preventDefault();
                openFullTextFromButton(button);
            });
        });
 
         document.addEventListener('keydown', handleModalKeydown);

        const comparisonDataElement = document.getElementById('comparisonData');
        if (comparisonDataElement) {
            try {
                comparisonPapersData = JSON.parse(comparisonDataElement.textContent || '[]');
            } catch (error) {
                console.error('Failed to parse comparison data:', error);
                comparisonPapersData = [];
            }
        }

        const urlParams = new URLSearchParams(window.location.search);
        const idsParam = urlParams.get('ids');
        
        if (!idsParam) {
            // Load from localStorage
            const comparisonIds = JSON.parse(localStorage.getItem('comparisonIds') || '[]');
            if (comparisonIds.length > 0) {
                const idsParam = comparisonIds.join(',');
                window.location.href = "{{ url_for('compare') }}?ids=" + idsParam;
            }
        } else {
            // Set CSS variable for dynamic column count
            const paperCount = idsParam.split(',').length;
            console.log('Setting paper count to:', paperCount);
            document.documentElement.style.setProperty('--paper-count', paperCount);
            console.log('CSS variable set:', document.documentElement.style.getPropertyValue('--paper-count'));
            
            // Track comparison page visit
            trackVisit(idsParam.split(','));
        }
        
        // Check content length and hide unnecessary View Full buttons
        setTimeout(checkContentLength, 100);
    });
    
    // Track comparison page visit
    function trackVisit(paperIds) {
        fetch('/api/track/compare_view', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ paper_ids: paperIds })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Compare view tracked:', data);
        })
        .catch(error => {
            console.error('Error tracking compare view:', error);
        });
    }
    
    function addStudy() {
        window.location.href = "{{ url_for('search') }}";
    }

    function removeStudy(paperId) {
        if (!paperId) {
            return;
        }

        const compareUrl = "{{ url_for('compare') }}";
        const urlParams = new URLSearchParams(window.location.search);
        const idsParam = urlParams.get('ids');

        let comparisonIds = [];
        if (idsParam) {
            comparisonIds = idsParam.split(',').filter(Boolean);
        } else {
            comparisonIds = JSON.parse(localStorage.getItem('comparisonIds') || '[]');
        }

        const updatedIds = comparisonIds.filter(id => id !== paperId);
        localStorage.setItem('comparisonIds', JSON.stringify(updatedIds));

        if (updatedIds.length > 0) {
            window.location.href = `${compareUrl}?ids=${updatedIds.join(',')}`;
        } else {
            window.location.href = compareUrl;
        }
    }
 
    function downloadComparison() {
        try {
            // Get comparison data
            const comparisonData = generateComparisonData();
            
            if (!comparisonData.papers || comparisonData.papers.length === 0) {
                showNotification('No studies to download. Please add studies to compare first.', 'warning');
                return;
            }
            
            // Create CSV content
            const csvContent = generateCSV(comparisonData);
            
            // Create timestamp for filename
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `comparison_${timestamp}.csv`;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the URL object
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            // Track download
            const paperIds = comparisonData.papers.map(p => p.id);
            trackDownload(paperIds);
            
            showNotification('Comparison downloaded successfully as ' + filename, 'success');
        } catch (error) {
            console.error('Error downloading comparison:', error);
            showNotification('Failed to download comparison. Please try again.', 'error');
        }
    }
    
    // Track comparison download
    function trackDownload(paperIds) {
        fetch('/api/track/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ paper_ids: paperIds })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Download tracked:', data);
        })
        .catch(error => {
            console.error('Error tracking download:', error);
        });
    }
    
    function saveComparison() {
        // Get comparison data
        const comparisonData = generateComparisonData();
        
        // Get saved comparisons
        let savedComparisons = JSON.parse(localStorage.getItem('savedComparisons') || '[]');
        
        // Create new comparison entry
        const comparisonEntry = {
            id: Date.now().toString(),
            name: `Comparison ${savedComparisons.length + 1}`,
            date: new Date().toLocaleDateString(),
            papers: comparisonData.papers,
            features: comparisonData.features
        };
        
        // Add to saved comparisons
        savedComparisons.push(comparisonEntry);
        localStorage.setItem('savedComparisons', JSON.stringify(savedComparisons));
        
        showNotification('Comparison saved successfully');
    }
    
    function generateComparisonData() {
        const papers = Array.isArray(comparisonPapersData) ? comparisonPapersData : [];
        const features = [
            'Authors', 'Title', 'Journal', 'Year', 'Citation', 'Abstract',
            'Sample Size', 'Country / Region', 'Recruitment Source', 'Demographics', 'Incentive',
            'Treatment / Independent variable(s)', 'Survey Measures (treatment variables)',
            'Outcome / Dependent variable(s)', 'Survey Measures (outcome variables)', 'Analysis (estimating equation)',
            'Main Effects', 'Moderators', 'Moderation Results',
            'Socio-cultural context', 'Political context', 'Platform / Technological context', 'Temporal context'
        ];
        
        return { papers, features };
    }
    
    function generateCSV(data) {
        const comparisonPapers = Array.isArray(data?.papers) ? data.papers : [];
        const comparisonFeatures = Array.isArray(data?.features) ? data.features : [];
         
        // Create header row
        let csv = 'Feature,' + comparisonPapers.map((paper, index) => `Study ${index + 1}`).join(',') + '\n';
        
        // Add data rows
        comparisonFeatures.forEach(feature => {
            const row = [feature];
            comparisonPapers.forEach(paper => {
                let value = '';
                switch(feature) {
                    case 'Authors':
                        value = paper.authors.join(', ');
                        break;
                    case 'Title':
                        value = paper.title;
                        break;
                    case 'Journal':
                        value = paper.journal;
                        break;
                    case 'Year':
                        value = paper.year;
                        break;
                    case 'Citation':
                        value = paper.citation || '';
                        break;
                    case 'Abstract':
                        value = paper.abstract;
                        break;
                    case 'Sample Size':
                        value = paper.sample_size ? paper.sample_size.toLocaleString() : '';
                        break;
                    case 'Country / Region':
                        value = paper.extracted_features.country_region || '';
                        break;
                    case 'Recruitment Source':
                        value = paper.extracted_features.recruitment_source || '';
                        break;
                    case 'Demographics':
                        value = paper.extracted_features.demographics || '';
                        break;
                    case 'Incentive':
                        value = paper.extracted_features.incentive || '';
                        break;
                    case 'Treatment / Independent variable(s)':
                        value = paper.extracted_features.independent_variables || '';
                        break;
                    case 'Survey Measures (treatment variables)':
                        value = paper.extracted_features.survey_questions || '';
                        break;
                    case 'Outcome / Dependent variable(s)':
                        value = paper.extracted_features.dependent_variables || '';
                        break;
                    case 'Survey Measures (outcome variables)':
                        value = paper.extracted_features.survey_questions || '';
                        break;
                    case 'Analysis (estimating equation)':
                        value = paper.extracted_features.analysis_equations || '';
                        break;
                    case 'Main Effects':
                        value = paper.extracted_features.main_effects || '';
                        break;
                    case 'Moderators':
                        value = paper.extracted_features.moderators || '';
                        break;
                    case 'Moderation Results':
                        value = paper.extracted_features.moderation_results || '';
                        break;
                    case 'Socio-cultural context':
                        value = paper.extracted_features.sociocultural_context || '';
                        break;
                    case 'Political context':
                        value = paper.extracted_features.political_context || '';
                        break;
                    case 'Platform / Technological context':
                        value = paper.extracted_features.platform_technological_context || '';
                        break;
                    case 'Temporal context':
                        value = paper.extracted_features.temporal_context || '';
                        break;
                }
                // Convert to string and escape commas and quotes in CSV
                value = String(value || '');
                value = value.replace(/"/g, '""');
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    value = '"' + value + '"';
                }
                row.push(value);
            });
            csv += row.join(',') + '\n';
        });
        
        return csv;
    }
    
    function clearComparison() {
        localStorage.removeItem('comparisonIds');
        window.location.href = "{{ url_for('compare') }}";
    }
    
    function showNotification(message, type = 'success') {
        // Define colors for different types
        const colors = {
            success: '#28a745',
            warning: '#ffc107',
            error: '#dc3545',
            info: '#17a2b8'
        };
        
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type] || colors.success};
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            max-width: 400px;
            word-wrap: break-word;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 3000);
    }
    
    function openFullTextFromButton(button) {
        if (!button) {
            return;
        }

        const targetId = button.dataset.fullTextId;
        const featureLabel = button.dataset.featureLabel || 'Full Text';
        const studyIndex = parseInt(button.dataset.studyIndex || '0', 10);
        let studyLabel = button.dataset.studyTitle || '';

        const fullTextElement = targetId ? document.getElementById(targetId) : null;
        const htmlContent = fullTextElement ? fullTextElement.innerHTML.trim() : '';

        if (!fullTextElement || !htmlContent) {
            showNotification('Full text is not available for this feature.', 'warning');
            return;
        }

        if (!studyLabel && Number.isInteger(studyIndex)) {
            const headerRow = document.querySelector('.table-header');
            const headerCell = headerRow?.children?.[studyIndex];
            if (headerCell) {
                const titleElement = headerCell.querySelector('.study-title');
                const metaElement = headerCell.querySelector('.study-meta');
                studyLabel = titleElement ? titleElement.textContent.trim() : `Study ${studyIndex}`;
                const metaText = metaElement ? metaElement.textContent.trim() : '';
                if (metaText) {
                    studyLabel = studyLabel ? `${studyLabel} • ${metaText}` : metaText;
                }
            }
        }

        showFullTextModal(featureLabel, studyLabel, htmlContent);
    }

    function showFullTextModal(featureLabel, studyLabel, htmlContent) {
        if (!modalElements.container) {
            return;
        }

        modalElements.title.textContent = featureLabel || 'Full Text';

        if (studyLabel) {
            modalElements.subtitle.textContent = studyLabel;
            modalElements.subtitle.style.display = 'block';
        } else {
            modalElements.subtitle.textContent = '';
            modalElements.subtitle.style.display = 'none';
        }

        modalElements.body.innerHTML = htmlContent;
        modalElements.container.classList.remove('hidden');
        modalElements.container.setAttribute('aria-hidden', 'false');
        document.body.classList.add('modal-open');
    }

    function closeFullTextModal() {
        if (!modalElements.container) {
            return;
        }

        modalElements.container.classList.add('hidden');
        modalElements.container.setAttribute('aria-hidden', 'true');
        modalElements.body.innerHTML = '';
        document.body.classList.remove('modal-open');
    }

    function handleModalKeydown(event) {
        if (event.key === 'Escape' && modalElements.container && !modalElements.container.classList.contains('hidden')) {
            closeFullTextModal();
        }
    }

    function checkContentLength() {
         // Hide View Full buttons when verbatim content is same as condensed content
         // This handles cases where the database may have identical condensed and verbatim versions
        document.querySelectorAll('.feature-content').forEach(content => {
            const summary = content.querySelector('.feature-summary');
            const summaryText = summary ? summary.textContent.trim() : '';

            content.querySelectorAll('.full-text-trigger').forEach(button => {
                const targetId = button.dataset.fullTextId;
                const fullTextElement = targetId ? document.getElementById(targetId) : null;
                const fullTextContent = fullTextElement ? fullTextElement.textContent.trim() : '';

                if (summaryText && fullTextContent && summaryText === fullTextContent) {
                    button.style.display = 'none';
                }
            });
        });
    }
</script>
{% endblock %}