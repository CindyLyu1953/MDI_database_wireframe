{% extends "base.html" %}

{% block title %}Research Comparison - Questionnaire Database Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/compare.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <!-- Comparison Header -->
    <section class="compare-header">
        <h1 class="page-title">Research Comparison</h1>
        <p class="page-description">Side-by-side comparison of key features from different studies, discovering operationalization differences and measurement method variations</p>
        
        <div class="compare-actions">
            <button class="btn btn-primary" onclick="addStudy()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14,2 14,8 20,8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10,9 9,9 8,9"></polyline>
                </svg>
                Add Study
            </button>
            <button class="btn btn-outline" onclick="downloadComparison()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Download Comparison
            </button>
            <button class="btn btn-outline" onclick="saveComparison()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                    <polyline points="17,21 17,13 7,13 7,21"></polyline>
                    <polyline points="7,3 7,8 15,8"></polyline>
                </svg>
                Save Comparison
            </button>
            <button class="btn btn-outline" onclick="clearComparison()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 6h18"></path>
                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                </svg>
                Clear Comparison
            </button>
        </div>
    </section>

    <!-- Comparison Content -->
    <section class="compare-content">
        {% if papers %}
        <div class="comparison-table-container">
            <div class="comparison-table">
                <!-- Table Header -->
                <div class="table-header">
                    <div class="header-cell feature-column">Features</div>
                    {% for paper in papers %}
                    <div class="header-cell study-column">
                        <div class="study-header">
                            <h3>Study {{ loop.index }}</h3>
                        </div>
                        <div class="study-title">{{ paper.title }}</div>
                        <div class="study-meta">{{ paper.authors|join(', ') }}, {{ paper.year }}</div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Bibliographic Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Bibliographic</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Authors</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.authors|join(', ') }}</div>
                            {% if paper.authors_verbatim and paper.authors_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('authors-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="authors-{{ loop.index }}-full">
                                <p>{{ paper.authors_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Title</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.title }}</div>
                            {% if paper.title_verbatim and paper.title_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('title-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="title-{{ loop.index }}-full">
                                <p>{{ paper.title_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Journal</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.journal }}</div>
                            {% if paper.journal_verbatim and paper.journal_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('journal-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="journal-{{ loop.index }}-full">
                                <p>{{ paper.journal_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Year</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">{{ paper.year }}</div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Citation</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">{{ paper.citation or '' }}</div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Abstract</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.abstract[:200] }}{% if paper.abstract|length > 200 %}...{% endif %}</div>
                            {% if paper.abstract_verbatim and paper.abstract_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('abstract-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="abstract-{{ loop.index }}-full">
                                <p>{{ paper.abstract_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Research Design & Sample Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Research Design & Sample</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Sample Size</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ "{:,}".format(paper.sample_size) if paper.sample_size else '' }}</div>
                            {% if paper.extracted_features.sample_size_verbatim and paper.extracted_features.sample_size_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('sample_size-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="sample_size-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.sample_size_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Country / Region</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.country_region or '' }}</div>
                            {% if paper.extracted_features.country_region_verbatim and paper.extracted_features.country_region_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('country_region-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="country_region-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.country_region_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Recruitment Source</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.recruitment_source or '' }}</div>
                            {% if paper.extracted_features.recruitment_source_verbatim and paper.extracted_features.recruitment_source_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('recruitment_source-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="recruitment_source-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.recruitment_source_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Demographics</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.demographics or '' }}</div>
                            {% if paper.extracted_features.demographics_verbatim and paper.extracted_features.demographics_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('demographics-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="demographics-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.demographics_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Incentive</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.incentive or '' }}</div>
                            {% if paper.extracted_features.incentive_verbatim and paper.extracted_features.incentive_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('incentive-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="incentive-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.incentive_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <!-- Measurement & Analysis Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Measurement & Analysis</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Treatment / Independent variable(s)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.independent_variables or '' }}</div>
                            {% if paper.extracted_features.independent_variables_verbatim and paper.extracted_features.independent_variables_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('independent_variables-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="independent_variables-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.independent_variables_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Survey Measures (treatment variables)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.survey_questions or '' }}</div>
                            {% if paper.extracted_features.survey_questions_verbatim and paper.extracted_features.survey_questions_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('survey_questions-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="survey_questions-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.survey_questions_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Outcome / Dependent variable(s)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.dependent_variables or '' }}</div>
                            {% if paper.extracted_features.dependent_variables_verbatim and paper.extracted_features.dependent_variables_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('dependent_variables-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="dependent_variables-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.dependent_variables_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Survey Measures (outcome variables)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.survey_questions or '' }}</div>
                            {% if paper.extracted_features.survey_questions_verbatim and paper.extracted_features.survey_questions_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('survey_questions_outcome-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="survey_questions_outcome-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.survey_questions_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Analysis (estimating equation)</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.analysis_equations or '' }}</div>
                            {% if paper.extracted_features.analysis_equations_verbatim and paper.extracted_features.analysis_equations_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('analysis_equations-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="analysis_equations-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.analysis_equations_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Findings Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Findings</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Main Effects</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.main_effects or '' }}</div>
                            {% if paper.extracted_features.main_effects_verbatim and paper.extracted_features.main_effects_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('main_effects-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="main_effects-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.main_effects_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Moderators</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.moderators or '' }}</div>
                            {% if paper.extracted_features.moderators_verbatim and paper.extracted_features.moderators_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('moderators-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="moderators-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.moderators_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Moderation Results</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.moderation_results or '' }}</div>
                            {% if paper.extracted_features.moderation_results_verbatim and paper.extracted_features.moderation_results_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('moderation_results-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="moderation_results-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.moderation_results_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Context Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell"></div>
                    {% endfor %}
                </div>
                
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Socio-cultural context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.sociocultural_context or '' }}</div>
                            {% if paper.extracted_features.sociocultural_context_verbatim and paper.extracted_features.sociocultural_context_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('sociocultural_context-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="sociocultural_context-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.sociocultural_context_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Political context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.political_context or '' }}</div>
                            {% if paper.extracted_features.political_context_verbatim and paper.extracted_features.political_context_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('political_context-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="political_context-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.political_context_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Platform / Technological context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.platform_technological_context or '' }}</div>
                            {% if paper.extracted_features.platform_technological_context_verbatim and paper.extracted_features.platform_technological_context_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('platform_technological_context-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="platform_technological_context-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.platform_technological_context_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">Temporal context</div>
                    </div>
                    {% for paper in papers %}
                    <div class="study-cell">
                        <div class="feature-content">
                            <div class="feature-summary">{{ paper.extracted_features.temporal_context or '' }}</div>
                            {% if paper.extracted_features.temporal_context_verbatim and paper.extracted_features.temporal_context_verbatim != 'NOT SPECIFIED' %}
                            <button class="btn btn-outline btn-sm" onclick="toggleFullText('temporal_context-{{ loop.index }}')">
                                <span class="btn-text">View Full</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6,9 12,15 18,9"></polyline>
                                </svg>
                            </button>
                            <div class="feature-full-text hidden" id="temporal_context-{{ loop.index }}-full">
                                <p>{{ paper.extracted_features.temporal_context_verbatim }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-comparison">
            <h3>No Studies Selected</h3>
            <p>Add studies from search results to compare them side by side.</p>
            <a href="{{ url_for('search') }}" class="btn btn-primary">Add Studies</a>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load comparison from localStorage if no papers are provided via URL
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const idsParam = urlParams.get('ids');
        
        if (!idsParam) {
            // Load from localStorage
            const comparisonIds = JSON.parse(localStorage.getItem('comparisonIds') || '[]');
            if (comparisonIds.length > 0) {
                const idsParam = comparisonIds.join(',');
                window.location.href = "{{ url_for('compare') }}?ids=" + idsParam;
            }
        } else {
            // Set CSS variable for dynamic column count
            const paperCount = idsParam.split(',').length;
            console.log('Setting paper count to:', paperCount);
            document.documentElement.style.setProperty('--paper-count', paperCount);
            console.log('CSS variable set:', document.documentElement.style.getPropertyValue('--paper-count'));
            
            // Track comparison page visit
            trackVisit(idsParam.split(','));
        }
        
        // Check content length and hide unnecessary View Full buttons
        setTimeout(checkContentLength, 100);
    });
    
    // Track comparison page visit
    function trackVisit(paperIds) {
        fetch('/api/track/compare_view', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ paper_ids: paperIds })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Compare view tracked:', data);
        })
        .catch(error => {
            console.error('Error tracking compare view:', error);
        });
    }
    
    function addStudy() {
        window.location.href = "{{ url_for('search') }}";
    }
    
    function downloadComparison() {
        try {
            // Get comparison data
            const comparisonData = generateComparisonData();
            
            if (!comparisonData.papers || comparisonData.papers.length === 0) {
                showNotification('No studies to download. Please add studies to compare first.', 'warning');
                return;
            }
            
            // Create CSV content
            const csvContent = generateCSV(comparisonData);
            
            // Create timestamp for filename
            const timestamp = new Date().toISOString().split('T')[0];
            const filename = `comparison_${timestamp}.csv`;
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Clean up the URL object
            setTimeout(() => URL.revokeObjectURL(url), 100);
            
            // Track download
            const paperIds = comparisonData.papers.map(p => p.id);
            trackDownload(paperIds);
            
            showNotification('Comparison downloaded successfully as ' + filename, 'success');
        } catch (error) {
            console.error('Error downloading comparison:', error);
            showNotification('Failed to download comparison. Please try again.', 'error');
        }
    }
    
    // Track comparison download
    function trackDownload(paperIds) {
        fetch('/api/track/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ paper_ids: paperIds })
        })
        .then(response => response.json())
        .then(data => {
            console.log('Download tracked:', data);
        })
        .catch(error => {
            console.error('Error tracking download:', error);
        });
    }
    
    function saveComparison() {
        // Get comparison data
        const comparisonData = generateComparisonData();
        
        // Get saved comparisons
        let savedComparisons = JSON.parse(localStorage.getItem('savedComparisons') || '[]');
        
        // Create new comparison entry
        const comparisonEntry = {
            id: Date.now().toString(),
            name: `Comparison ${savedComparisons.length + 1}`,
            date: new Date().toLocaleDateString(),
            papers: comparisonData.papers,
            features: comparisonData.features
        };
        
        // Add to saved comparisons
        savedComparisons.push(comparisonEntry);
        localStorage.setItem('savedComparisons', JSON.stringify(savedComparisons));
        
        showNotification('Comparison saved successfully');
    }
    
    function generateComparisonData() {
        const papers = {{ papers|tojson }};
        const features = [
            'Authors', 'Title', 'Journal', 'Year', 'Citation', 'Abstract',
            'Sample Size', 'Country / Region', 'Recruitment Source', 'Demographics', 'Incentive',
            'Treatment / Independent variable(s)', 'Survey Measures (treatment variables)',
            'Outcome / Dependent variable(s)', 'Survey Measures (outcome variables)', 'Analysis (estimating equation)',
            'Main Effects', 'Moderators', 'Moderation Results',
            'Socio-cultural context', 'Political context', 'Platform / Technological context', 'Temporal context'
        ];
        
        return { papers, features };
    }
    
    function generateCSV(data) {
        const { papers, features } = data;
        
        // Create header row
        let csv = 'Feature,' + papers.map((paper, index) => `Study ${index + 1}`).join(',') + '\n';
        
        // Add data rows
        features.forEach(feature => {
            const row = [feature];
            papers.forEach(paper => {
                let value = '';
                switch(feature) {
                    case 'Authors':
                        value = paper.authors.join(', ');
                        break;
                    case 'Title':
                        value = paper.title;
                        break;
                    case 'Journal':
                        value = paper.journal;
                        break;
                    case 'Year':
                        value = paper.year;
                        break;
                    case 'Citation':
                        value = paper.citation || '';
                        break;
                    case 'Abstract':
                        value = paper.abstract;
                        break;
                    case 'Sample Size':
                        value = paper.sample_size ? paper.sample_size.toLocaleString() : '';
                        break;
                    case 'Country / Region':
                        value = paper.extracted_features.country_region || '';
                        break;
                    case 'Recruitment Source':
                        value = paper.extracted_features.recruitment_source || '';
                        break;
                    case 'Demographics':
                        value = paper.extracted_features.demographics || '';
                        break;
                    case 'Incentive':
                        value = paper.extracted_features.incentive || '';
                        break;
                    case 'Treatment / Independent variable(s)':
                        value = paper.extracted_features.independent_variables || '';
                        break;
                    case 'Survey Measures (treatment variables)':
                        value = paper.extracted_features.survey_questions || '';
                        break;
                    case 'Outcome / Dependent variable(s)':
                        value = paper.extracted_features.dependent_variables || '';
                        break;
                    case 'Survey Measures (outcome variables)':
                        value = paper.extracted_features.survey_questions || '';
                        break;
                    case 'Analysis (estimating equation)':
                        value = paper.extracted_features.analysis_equations || '';
                        break;
                    case 'Main Effects':
                        value = paper.extracted_features.main_effects || '';
                        break;
                    case 'Moderators':
                        value = paper.extracted_features.moderators || '';
                        break;
                    case 'Moderation Results':
                        value = paper.extracted_features.moderation_results || '';
                        break;
                    case 'Socio-cultural context':
                        value = paper.extracted_features.sociocultural_context || '';
                        break;
                    case 'Political context':
                        value = paper.extracted_features.political_context || '';
                        break;
                    case 'Platform / Technological context':
                        value = paper.extracted_features.platform_technological_context || '';
                        break;
                    case 'Temporal context':
                        value = paper.extracted_features.temporal_context || '';
                        break;
                }
                // Convert to string and escape commas and quotes in CSV
                value = String(value || '');
                value = value.replace(/"/g, '""');
                if (value.includes(',') || value.includes('"') || value.includes('\n')) {
                    value = '"' + value + '"';
                }
                row.push(value);
            });
            csv += row.join(',') + '\n';
        });
        
        return csv;
    }
    
    function clearComparison() {
        localStorage.removeItem('comparisonIds');
        window.location.href = "{{ url_for('compare') }}";
    }
    
    function showNotification(message, type = 'success') {
        // Define colors for different types
        const colors = {
            success: '#28a745',
            warning: '#ffc107',
            error: '#dc3545',
            info: '#17a2b8'
        };
        
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type] || colors.success};
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            font-size: 14px;
            font-weight: 500;
            max-width: 400px;
            word-wrap: break-word;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // Remove after 3 seconds
        setTimeout(() => {
            if (document.body.contains(notification)) {
                document.body.removeChild(notification);
            }
        }, 3000);
    }
    
    function toggleFullText(featureId) {
        const fullTextElement = document.getElementById(featureId + '-full');
        const button = event.target.closest('button');
        
        if (fullTextElement.classList.contains('hidden')) {
            fullTextElement.classList.remove('hidden');
            button.querySelector('.btn-text').textContent = 'Hide Full';
        } else {
            fullTextElement.classList.add('hidden');
            button.querySelector('.btn-text').textContent = 'View Full';
        }
    }

    function checkContentLength() {
        // Hide View Full buttons when verbatim content is same as condensed content
        // This handles cases where the database may have identical condensed and verbatim versions
        document.querySelectorAll('.feature-content').forEach(content => {
            const summary = content.querySelector('.feature-summary');
            const fullText = content.querySelector('.feature-full-text');
            const button = content.querySelector('button[onclick*="toggleFullText"]');
            
            if (summary && fullText && button) {
                const summaryText = summary.textContent.trim();
                const fullTextContent = fullText.textContent.trim();
                
                // Hide button if verbatim content is identical to condensed content
                if (summaryText === fullTextContent) {
                    button.style.display = 'none';
                }
            }
        });
    }
</script>
{% endblock %}