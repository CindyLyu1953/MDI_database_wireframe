{% extends "base.html" %}

{% block title %}Admin Dashboard - Questionnaire Database Platform{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        background: white;
        margin-left: calc(-50vw + 50%);
        margin-right: calc(-50vw + 50%);
        padding: 2rem calc(50vw - 50%);
        border-bottom: 1px solid #e5e7eb;
        margin-bottom: 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .admin-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .dashboard-title {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .logout-btn {
        padding: 0.5rem 1.5rem;
        background: #ef4444;
        color: white;
        border: none;
        border-radius: 0.375rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    
    .logout-btn:hover {
        background: #dc2626;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
    }
    
    .stat-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .stat-card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    
    .stat-card-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .icon-blue { background: #dbeafe; color: #3b82f6; }
    .icon-green { background: #d1fae5; color: #10b981; }
    .icon-purple { background: #e9d5ff; color: #8b5cf6; }
    
    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f2937;
    }
    
    .stat-description {
        font-size: 0.875rem;
        color: #6b7280;
        margin-top: 0.5rem;
    }
    
    .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .tab {
        padding: 0.75rem 1.5rem;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        margin-bottom: -2px;
        cursor: pointer;
        font-weight: 500;
        color: #6b7280;
        transition: all 0.15s ease-in-out;
    }
    
    .tab:hover {
        color: #3b82f6;
    }
    
    .tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .data-table {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }
    
    .table-header {
        background: #f9fafb;
        padding: 1rem 1.5rem;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .table-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
    }
    
    .table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
    }
    
    table {
        width: 100%;
        border-collapse: collapse;
    }
    
    th {
        background: #f9fafb;
        padding: 0.75rem 1.5rem;
        text-align: left;
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    td {
        padding: 1rem 1.5rem;
        border-top: 1px solid #e5e7eb;
        font-size: 0.875rem;
        color: #374151;
    }
    
    tr:hover {
        background: #f9fafb;
    }
    
    .timestamp {
        color: #6b7280;
        font-size: 0.8125rem;
    }
    
    .paper-ids {
        font-family: monospace;
        font-size: 0.75rem;
        color: #6b7280;
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .search-query {
        font-weight: 500;
        color: #3b82f6;
    }
    
    .top-searches {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .top-searches-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1rem;
    }
    
    .search-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .search-item:last-child {
        border-bottom: none;
    }
    
    .search-query-text {
        font-weight: 500;
        color: #374151;
    }
    
    .search-count {
        background: #dbeafe;
        color: #3b82f6;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        color: #6b7280;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Admin Dashboard</h1>
        <div class="admin-actions">
            <a href="{{ url_for('admin_requests') }}" class="btn btn-primary">Review Requests</a>
            <a href="{{ url_for('admin_logout') }}" class="logout-btn">Logout</a>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Total Searches</span>
                <div class="stat-card-icon icon-blue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-number" id="totalSearches">0</div>
            <div class="stat-description"><span id="recentSearches">0</span> in the last 7 days</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Compare Views</span>
                <div class="stat-card-icon icon-green">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 11H5a2 2 0 0 0-2 2v3c0 1.1.9 2 2 2h4m0-7v7m0-7h10a2 2 0 0 1 2 2v3c0 1.1-.9 2-2 2H9m0-7V9a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </div>
            </div>
            <div class="stat-number" id="totalCompares">0</div>
            <div class="stat-description"><span id="recentCompares">0</span> in the last 7 days</div>
        </div>
        
        <div class="stat-card">
            <div class="stat-card-header">
                <span class="stat-card-title">Downloads</span>
                <div class="stat-card-icon icon-purple">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7,10 12,15 17,10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                </div>
            </div>
            <div class="stat-number" id="totalDownloads">0</div>
            <div class="stat-description"><span id="recentDownloads">0</span> in the last 7 days</div>
        </div>
    </div>
    
    <!-- Top Searches -->
    <div class="top-searches">
        <h2 class="top-searches-title">Top Search Queries</h2>
        <div id="topSearchesList">
            <div class="loading">Loading...</div>
        </div>
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
        <button class="tab active" onclick="showTab('searches')">Search Logs</button>
        <button class="tab" onclick="showTab('compares')">Compare Views</button>
        <button class="tab" onclick="showTab('downloads')">Downloads</button>
    </div>
    
    <!-- Search Logs Tab -->
    <div id="searches-tab" class="tab-content active">
        <div class="data-table">
            <div class="table-header">
                <h3 class="table-title">Recent Search Queries</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Search Query</th>
                            <th>Filters Used</th>
                            <th>Results</th>
                            <th>Session</th>
                        </tr>
                    </thead>
                    <tbody id="searchLogsTable">
                        <tr>
                            <td colspan="4" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Compare Views Tab -->
    <div id="compares-tab" class="tab-content">
        <div class="data-table">
            <div class="table-header">
                <h3 class="table-title">Recent Compare Views</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Paper IDs</th>
                            <th># Papers</th>
                            <th>Session</th>
                        </tr>
                    </thead>
                    <tbody id="compareLogsTable">
                        <tr>
                            <td colspan="4" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Downloads Tab -->
    <div id="downloads-tab" class="tab-content">
        <div class="data-table">
            <div class="table-header">
                <h3 class="table-title">Recent Downloads</h3>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Paper IDs</th>
                            <th># Papers</th>
                            <th>Format</th>
                            <th>Session</th>
                        </tr>
                    </thead>
                    <tbody id="downloadLogsTable">
                        <tr>
                            <td colspan="5" class="loading">Loading data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Load dashboard data on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadStats();
        loadSearchLogs();
        loadCompareLogs();
        loadDownloadLogs();
    });
    
    function showTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }
    
    function loadStats() {
        fetch('/api/admin/stats')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalSearches').textContent = data.total_searches;
                document.getElementById('totalCompares').textContent = data.total_compares;
                document.getElementById('totalDownloads').textContent = data.total_downloads;
                document.getElementById('recentSearches').textContent = data.recent_searches;
                document.getElementById('recentCompares').textContent = data.recent_compares;
                document.getElementById('recentDownloads').textContent = data.recent_downloads;
                
                // Display top searches
                const topSearchesList = document.getElementById('topSearchesList');
                if (data.top_searches && data.top_searches.length > 0) {
                    topSearchesList.innerHTML = data.top_searches.map(item => `
                        <div class="search-item">
                            <span class="search-query-text">${item.search_query}</span>
                            <span class="search-count">${item.count} searches</span>
                        </div>
                    `).join('');
                } else {
                    topSearchesList.innerHTML = '<div class="empty-state">No search data yet</div>';
                }
            })
            .catch(error => {
                console.error('Error loading stats:', error);
            });
    }
    
    function loadSearchLogs() {
        fetch('/api/admin/search_logs')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('searchLogsTable');
                if (data.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" class="empty-state">No search logs yet</td></tr>';
                    return;
                }
                
                table.innerHTML = data.map(log => {
                    const filters = formatFilters(log.filters_used);
                    return `
                        <tr>
                            <td class="timestamp">${formatDate(log.timestamp)}</td>
                            <td><span class="search-query">${log.search_query || '(empty)'}</span></td>
                            <td>${filters}</td>
                            <td>${log.num_results}</td>
                            <td>${log.user_session}</td>
                        </tr>
                    `;
                }).join('');
            })
            .catch(error => {
                console.error('Error loading search logs:', error);
                document.getElementById('searchLogsTable').innerHTML = 
                    '<tr><td colspan="5" class="empty-state">Error loading data</td></tr>';
            });
    }
    
    function formatFilters(filtersJson) {
        try {
            const filters = JSON.parse(filtersJson || '{}');
            const filterKeys = Object.keys(filters);
            
            if (filterKeys.length === 0) {
                return '<span style="color: #9ca3af;">None</span>';
            }
            
            const filterLabels = {
                'year_from': 'Year ≥',
                'year_to': 'Year ≤',
                'journal': 'Journal',
                'country': 'Country'
            };
            
            const filterTags = filterKeys.map(key => {
                const label = filterLabels[key] || key;
                const value = filters[key];
                return `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; margin-right: 4px; display: inline-block; margin-bottom: 2px;">${label}: ${value}</span>`;
            }).join('');
            
            return filterTags;
        } catch (e) {
            return '<span style="color: #9ca3af;">None</span>';
        }
    }
    
    function loadCompareLogs() {
        fetch('/api/admin/compare_view_logs')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('compareLogsTable');
                if (data.length === 0) {
                    table.innerHTML = '<tr><td colspan="4" class="empty-state">No compare logs yet</td></tr>';
                    return;
                }
                
                table.innerHTML = data.map(log => `
                    <tr>
                        <td class="timestamp">${formatDate(log.timestamp)}</td>
                        <td class="paper-ids" title="${log.paper_ids}">${log.paper_ids}</td>
                        <td>${log.num_papers}</td>
                        <td>${log.user_session}</td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading compare logs:', error);
                document.getElementById('compareLogsTable').innerHTML = 
                    '<tr><td colspan="4" class="empty-state">Error loading data</td></tr>';
            });
    }
    
    function loadDownloadLogs() {
        fetch('/api/admin/download_logs')
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('downloadLogsTable');
                if (data.length === 0) {
                    table.innerHTML = '<tr><td colspan="5" class="empty-state">No download logs yet</td></tr>';
                    return;
                }
                
                table.innerHTML = data.map(log => `
                    <tr>
                        <td class="timestamp">${formatDate(log.timestamp)}</td>
                        <td class="paper-ids" title="${log.paper_ids}">${log.paper_ids}</td>
                        <td>${log.num_papers}</td>
                        <td>${log.file_format || 'CSV'}</td>
                        <td>${log.user_session}</td>
                    </tr>
                `).join('');
            })
            .catch(error => {
                console.error('Error loading download logs:', error);
                document.getElementById('downloadLogsTable').innerHTML = 
                    '<tr><td colspan="5" class="empty-state">Error loading data</td></tr>';
            });
    }
    
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
</script>
{% endblock %}

