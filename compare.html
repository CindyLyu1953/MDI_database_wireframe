<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Research Comparison - Questionnaire Database Platform</title>
    <link rel="stylesheet" href="styles/main.css">
    <link rel="stylesheet" href="styles/compare.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="logo">
                <h1>Questionnaire Database Platform</h1>
                <span class="tagline">Academic Research Tool</span>
            </div>
            <nav class="nav">
                <a href="index.html" class="nav-link">Home</a>
                <a href="search.html" class="nav-link">Search</a>
                <a href="compare.html" class="nav-link active">Compare</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Comparison Header -->
            <section class="compare-header">
                <h1 class="page-title">Research Comparison</h1>
                <p class="page-description">Side-by-side comparison of key features from different studies, discovering operationalization differences and measurement method variations</p>
                
                <div class="compare-actions">
                    <button class="btn btn-primary" onclick="addStudy()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y1="12"></line>
                        </svg>
                        Add Study
                    </button>
                    <button class="btn btn-outline" onclick="exportComparison()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7,10 12,15 17,10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Export Comparison
                    </button>
                    <button class="btn btn-outline" onclick="clearComparison()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                        Clear Comparison
                    </button>
                </div>
            </section>

            <!-- Comparison Content -->
            <section class="compare-content">
                <div class="comparison-table-container">
                    <div class="comparison-table" id="comparison-table">
                        <!-- Comparison table will be dynamically generated here -->
                    </div>
                </div>
            </section>

        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>About Us</h4>
                    <p>To provide efficient tools and platforms for academic research</p>
                </div>
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <a href="search.html">Search Research</a>
                    <a href="compare.html">Compare Features</a>
                </div>
                <div class="footer-section">
                    <h4>Contact Us</h4>
                    <p>support@questionnaire-platform.com</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Questionnaire Database Platform. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="js/csv-loader.js"></script>
    <script src="js/data-loader.js"></script>
    <script>
        function toggleFullText(measurementId) {
            const fullTextElement = document.getElementById(measurementId + '-full');
            const button = event.target.closest('button');
            
            if (fullTextElement.classList.contains('hidden')) {
                fullTextElement.classList.remove('hidden');
                button.textContent = 'Collapse';
            } else {
                fullTextElement.classList.add('hidden');
                button.textContent = 'View Full ' + getMeasurementName(measurementId);
            }
        }

        function getMeasurementName(measurementId) {
            const names = {
                'trust1': 'Scale',
                'trust2': 'Scale',
                'trust3': 'Details'
            };
            return names[measurementId] || 'Content';
        }

        function addStudy() {
            // Handle both file:// and http:// protocols
            if (window.location.protocol === 'file:') {
                // For file:// protocol, use relative path
                window.location.href = 'search.html';
            } else {
                // For http:// protocol, use absolute path
                window.location.href = `${window.location.origin}/search.html`;
            }
        }

        function removeStudy(studyId) {
            window.dataLoader.removeFromComparison(studyId);
            loadComparisonTable();
            showNotification('Study removed from comparison');
        }

        function exportComparison() {
            const comparisonList = window.dataLoader.getComparisonList();
            if (comparisonList.length === 0) {
                showNotification('No studies to export');
                return;
            }

            const data = {
                comparisonDate: new Date().toISOString(),
                studies: comparisonList.map(paper => ({
                    id: paper.id,
                    title: paper.title,
                    authors: paper.authors,
                    journal: paper.journal,
                    year: paper.year,
                    sampleSize: paper.sample_size,
                    countries: paper.countries,
                    methodology: paper.methodology,
                    extractedFeatures: paper.extracted_features
                }))
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `comparison_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification('Comparison exported');
        }

        function clearComparison() {
            if (confirm('Are you sure you want to clear all studies from comparison?')) {
                window.dataLoader.comparisonList = [];
                window.dataLoader.saveComparison();
                loadComparisonTable();
                showNotification('Comparison cleared');
            }
        }

        function loadComparisonTable() {
            const comparisonList = window.dataLoader.getComparisonList();
            const comparisonTable = document.getElementById('comparison-table');
            
            if (comparisonList.length === 0) {
                comparisonTable.innerHTML = `
                    <div class="empty-comparison">
                        <h3>No Studies Selected</h3>
                        <p>Add studies from search results to compare them side by side.</p>
                        <button class="btn btn-primary" onclick="addStudy()">Add Studies</button>
                    </div>
                `;
                return;
            }

            // Generate comparison table
            const tableHTML = generateComparisonTable(comparisonList);
            comparisonTable.innerHTML = tableHTML;
        }

        function generateComparisonTable(studies) {
            let tableHTML = `
                <!-- Table Header -->
                <div class="table-header">
                    <div class="header-cell feature-column">Features</div>
                    ${studies.map((study, index) => `
                        <div class="header-cell study-column">
                            <div class="study-header">
                                <h3>Study ${index + 1}</h3>
                                <button class="remove-study-btn" onclick="removeStudy('${study.id}')">Ã—</button>
                            </div>
                            <div class="study-title">${study.title}</div>
                            <div class="study-meta">${study.authors.join(', ')}, ${study.year}</div>
                        </div>
                    `).join('')}
                </div>

                <!-- Basic Information Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Basic Information</div>
                    </div>
                    ${studies.map(() => '<div class="study-cell"></div>').join('')}
                </div>
                
                ${generateComparisonRows('Authors', studies, study => study.authors.join(', '))}
                ${generateComparisonRows('Title', studies, study => study.title)}
                ${generateComparisonRows('Journal', studies, study => study.journal)}
                ${generateComparisonRows('Year', studies, study => study.year)}
                ${generateComparisonRows('APA Style Citation', studies, study => study.citation || '')}
                ${generateComparisonRows('Abstract', studies, study => study.abstract ? study.abstract.substring(0, 200) + (study.abstract.length > 200 ? '...' : '') : '')}
                
                <!-- Experiment Design Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Experiment Design</div>
                    </div>
                    ${studies.map(() => '<div class="study-cell"></div>').join('')}
                </div>
                
                ${generateComparisonRows('Treatment / Independent Variables', studies, study => study.extracted_features?.independent_variables)}
                ${generateComparisonRows('Outcome / Dependent Variables', studies, study => study.extracted_features?.dependent_variables)}
                ${generateComparisonRows('Survey Questions', studies, study => study.extracted_features?.survey_questions)}
                ${generateComparisonRows('Incentive', studies, study => study.extracted_features?.incentive)}
                ${generateComparisonRows('Study Type', studies, study => study.extracted_features?.study_type)}
                ${generateComparisonRows('Analysis / Estimating Equations', studies, study => study.extracted_features?.analysis_equations)}
                ${generateComparisonRows('Level of Analysis', studies, study => study.extracted_features?.level_of_analysis)}
                
                <!-- Effects and Moderations Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Effects and Moderations</div>
                    </div>
                    ${studies.map(() => '<div class="study-cell"></div>').join('')}
                </div>
                
                ${generateComparisonRows('Main Effects', studies, study => study.extracted_features?.main_effects)}
                ${generateComparisonRows('Statistical Power', studies, study => study.extracted_features?.statistical_power)}
                ${generateComparisonRows('Moderators', studies, study => study.extracted_features?.moderators)}
                ${generateComparisonRows('Moderation Results', studies, study => study.extracted_features?.moderation_results)}
                
                <!-- Context Information Section -->
                <div class="table-row section-header">
                    <div class="feature-cell">
                        <div class="feature-name">Context Information</div>
                    </div>
                    ${studies.map(() => '<div class="study-cell"></div>').join('')}
                </div>
                
                ${generateComparisonRows('Demographics', studies, study => study.extracted_features?.demographics)}
                ${generateComparisonRows('Recruitment Source', studies, study => study.extracted_features?.recruitment_source)}
                ${generateComparisonRows('Sample Size', studies, study => study.sample_size ? study.sample_size.toLocaleString() : '')}
                ${generateComparisonRows('Country or Region', studies, study => study.extracted_features?.country_region)}
            `;

            return tableHTML;
        }

        // Helper function to generate comparison rows
        function generateComparisonRows(label, studies, getValue) {
            return `
                <div class="table-row">
                    <div class="feature-cell">
                        <div class="feature-name">${label}</div>
                    </div>
                    ${studies.map(study => {
                        const value = getValue(study);
                        return `
                            <div class="study-cell">
                                ${value && value !== 'NOT SPECIFIED' && value.trim() !== '' ? value : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            // Wait for data to load
            await window.dataLoader.loadPapers();
            loadComparisonTable();
        });
    </script>
</body>
</html>
